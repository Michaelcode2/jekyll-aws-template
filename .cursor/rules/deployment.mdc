---
description: AWS deployment and CI/CD configuration
globs: [".github/workflows/**", "aws_setup/**"]
---

# Deployment & CI/CD Guide

## Environment Management

- **Development (dev)**:
  - Deploy from `develop` or `dev` branch
  - Use dev S3 bucket and CloudFront distribution
  - May include draft content and debug information
- **Production (prod)**:
  - Deploy from `main` or `master` branch
  - Use production S3 bucket and CloudFront distribution
  - Optimized, minified assets
  - No debug information
  - Production-ready content only
  - allow seach robots scan production version only (robots.txt)

### S3 Configuration
- Static website hosting enabled
- Bucket policy for CloudFront OAC access
- Separate buckets per environment

### CloudFront Configuration
- SSL/TLS certificate from ACM
- Custom domain with Route 53
- CloudFront Function for index.html handling
- Cache invalidation after deploy

## CI/CD Workflow Requirements

- **GitHub Actions** (if using GitHub):
  - Workflow files in `.github/workflows/`
  - Separate workflows for dev and prod deployments
  - Build Jekyll site before deployment
  - Deploy to appropriate S3 bucket based on branch/environment
  - Invalidate CloudFront cache after deployment
- **GitLab CI** (if using GitLab):
  - `.gitlab-ci.yml` in project root
  - Separate stages for dev and prod
  - Use GitLab CI variables for AWS credentials
- Build process:
  - Install dependencies (Ruby gems)
  - Build Jekyll site (`jekyll build`)
  - Test build output
  - Deploy to S3
  - Invalidate CloudFront

### Required Secrets

| Secret | Description |
|--------|-------------|
| `AWS_ROLE_ARN` | IAM role ARN for GitHub Actions |
| `S3_BUCKET_DEV` | Dev S3 bucket name |
| `S3_BUCKET_PROD` | Prod S3 bucket name |
| `CLOUDFRONT_DISTRIBUTION_ID_DEV` | Dev CloudFront ID |
| `CLOUDFRONT_DISTRIBUTION_ID_PROD` | Prod CloudFront ID |

### Workflow Structure

```yaml
# .github/workflows/deploy-prod.yml
name: Deploy to Production

on:
  push:
    branches: [main]

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true
      
      - name: Build Jekyll
        run: JEKYLL_ENV=production bundle exec jekyll build
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: eu-central-1
      
      - name: Deploy to S3
        run: aws s3 sync _site/ s3://${{ secrets.S3_BUCKET_PROD }} --delete
      
      - name: Invalidate CloudFront
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ secrets.CLOUDFRONT_DISTRIBUTION_ID_PROD }} \
            --paths "/*"
```

## AWS OIDC Setup

### 1. Create OIDC Provider (once per AWS account)

```bash
aws iam create-open-id-connect-provider \
  --url https://token.actions.githubusercontent.com \
  --client-id-list sts.amazonaws.com \
  --thumbprint-list 6938fd4d98bab03faadb97b34396831e3780aea1
```

### 2. Trust Policy (github-trust-policy.json)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Principal": {
        "Federated": "arn:aws:iam::ACCOUNT_ID:oidc-provider/token.actions.githubusercontent.com"
      },
      "Action": "sts:AssumeRoleWithWebIdentity",
      "Condition": {
        "StringEquals": {
          "token.actions.githubusercontent.com:aud": "sts.amazonaws.com"
        },
        "StringLike": {
          "token.actions.githubusercontent.com:sub": "repo:ORG/REPO:*"
        }
      }
    }
  ]
}
```

### 3. Permissions Policy (github-permissions-policy.json)

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Effect": "Allow",
      "Action": [
        "s3:PutObject",
        "s3:GetObject",
        "s3:DeleteObject",
        "s3:ListBucket"
      ],
      "Resource": [
        "arn:aws:s3:::BUCKET_NAME",
        "arn:aws:s3:::BUCKET_NAME/*"
      ]
    },
    {
      "Effect": "Allow",
      "Action": "cloudfront:CreateInvalidation",
      "Resource": "arn:aws:cloudfront::ACCOUNT_ID:distribution/DISTRIBUTION_ID"
    }
  ]
}
```

## Local Build Commands

```bash
# Development build
bundle exec jekyll build

# Production build (minified, no drafts)
JEKYLL_ENV=production bundle exec jekyll build

# Build with specific config
bundle exec jekyll build --config _config.yml,_config_dev.yml

# Output to custom directory
bundle exec jekyll build --destination ./public
```

## Pre-deployment Checklist

- [ ] All tests pass locally
- [ ] `bundle exec jekyll doctor` shows no issues
- [ ] Ukrainian content reviewed for typos
- [ ] Images optimized (WebP where possible)
- [ ] Links verified (no broken links)
- [ ] SEO meta tags present on all pages
- [ ] Mobile responsiveness tested

## Rollback Procedure

If deployment causes issues:

1. Revert commit on GitHub
2. Push revert to trigger new deploy
3. Or manually sync previous S3 version

```bash
# List S3 object versions (if versioning enabled)
aws s3api list-object-versions --bucket BUCKET_NAME

# Restore specific version
aws s3api copy-object \
  --bucket BUCKET_NAME \
  --copy-source BUCKET_NAME/index.html?versionId=VERSION_ID \
  --key index.html
```
